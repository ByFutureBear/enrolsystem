@page
@model OnlineEnrolmentSystem.Pages.Statement.RegistrationSummaryModel
@using System
@using System.Linq

@{
    ViewData["Title"] = "Registration Summary / Class Timetable";

    // Days shown in the timetable
    string[] days = new[] { "Mon", "Tue", "Wed", "Thu", "Fri" };

    // 1-hour slots from 08:00 to 23:00 (last row is 22:00–23:00)
    var slots = Enumerable.Range(8, 15)
        .Select(h => new { Start = new TimeSpan(h, 0, 0), End = new TimeSpan(h + 1, 0, 0) })
        .ToList();

    // Does a schedule like "Fri 20:30-21:30" overlap with the given day/time slot?
    bool IsInSlot(string schedule, string day, TimeSpan slotStart, TimeSpan slotEnd)
    {
        if (string.IsNullOrWhiteSpace(schedule)) return false;

        var parts = schedule.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length != 2) return false;

        var classDay = parts[0];
        if (!classDay.Equals(day, StringComparison.OrdinalIgnoreCase))
            return false;

        var times = parts[1].Split('-', StringSplitOptions.RemoveEmptyEntries);
        if (times.Length != 2) return false;

        if (!TimeSpan.TryParse(times[0], out var start)) return false;
        if (!TimeSpan.TryParse(times[1], out var end)) return false;

        // any overlap with this hour cell
        return start < slotEnd && end > slotStart;
    }
}

@functions {
    // Unique pastel color per course code (HSL-based; avoids palette collisions)
    string ColorFor(string code)
    {
        code ??= "X";

        // Hue derived from a simple stable hash of the code (0..359)
        var h = Math.Abs(code.Aggregate(0, (a, ch) => unchecked(a * 31 + ch))) % 360;
        int s = 60; // saturation (pastel)
        int l = 85; // lightness  (pastel)

        // ---- HSL -> RGB -> HEX ----
        double C = (1 - Math.Abs(2 * l / 100.0 - 1)) * (s / 100.0);
        double X = C * (1 - Math.Abs((h / 60.0) % 2 - 1));
        double m = l / 100.0 - C / 2.0;

        double r, g, b;
        if (h < 60) { r = C; g = X; b = 0; }
        else if (h < 120) { r = X; g = C; b = 0; }
        else if (h < 180) { r = 0; g = C; b = X; }
        else if (h < 240) { r = 0; g = X; b = C; }
        else if (h < 300) { r = X; g = 0; b = C; }
        else { r = C; g = 0; b = X; }

        int R = (int)Math.Round((r + m) * 255);
        int G = (int)Math.Round((g + m) * 255);
        int B = (int)Math.Round((b + m) * 255);

        return $"#{R:X2}{G:X2}{B:X2}";
    }
}

<style>
    /* Timetable visuals */
    .tt-cell {
        min-width: 120px;
        min-height: 70px;
        vertical-align: middle;
    }

    .tt-stack > div {
        margin-bottom: .25rem;
    }

    .tt-pill {
        border-radius: .6rem;
        padding: .28rem .45rem;
        font-weight: 700;
        font-size: .85rem;
        display: inline-block;
        color: #1f2937; /* readable on pastels */
        box-shadow: 0 1px 0 rgba(0,0,0,.06);
        border: 1px solid rgba(0,0,0,.05);
        white-space: nowrap;
    }

    .table-fixed {
        table-layout: fixed;
    }

    .tt-legend .tt-pill {
        margin-right: .5rem;
        margin-bottom: .5rem;
    }
</style>

<div class="container my-4">

    <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">@ViewData["Title"]</h5>

        <form method="post" asp-page-handler="DownloadPdf">
            <button type="submit" class="btn btn-outline-primary btn-sm">
                Download PDF
            </button>
        </form>
    </div>

    <!-- Student Info -->
    <div class="card mt-3 shadow-sm">
        <div class="card-body">
            <h6 class="card-subtitle mb-3 text-muted">Student Info</h6>
            @if (Model.StudentInfo != null)
            {
                <div class="row g-2">
                    <div class="col-sm-4"><strong>Name:</strong> @Model.StudentInfo.Name</div>
                    <div class="col-sm-4"><strong>Email:</strong> @Model.StudentInfo.Email</div>
                    <div class="col-sm-4"><strong>Student ID:</strong> @Model.StudentInfo.StudentId</div>
                </div>
            }
            else
            {
                <div class="alert alert-warning mb-0">
                    Couldn’t load student info. Please ensure you’re logged in as a student account.
                </div>
            }
        </div>
    </div>

    <!-- Enroled Classes -->
    <div class="card mt-4 shadow-sm">
        <div class="card-body">
            <h6 class="card-subtitle mb-3 text-muted">Enroled Classes</h6>

            @if (Model.Enrolments?.Count > 0)
            {
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Section</th>
                                <th>Credits</th>
                                <th>Schedule</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var e in Model.Enrolments)
                            {
                                <tr>
                                    <td>@e.Class.Course.CourseCode - @e.Class.Course.CourseName</td>
                                    <td>@e.Class.Section</td>
                                    <td>@e.Class.Course.Credits</td>
                                    <td>@e.Class.Schedule</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-muted">No classes enroled.</div>
            }
        </div>
    </div>

    <!-- Weekly Timetable -->
    <div class="card mt-4 shadow-sm">
        <div class="card-body">
            <h6 class="card-subtitle mb-3 text-muted">Weekly Timetable</h6>

            <div class="table-responsive">
                <table class="table table-bordered table-sm text-center align-middle table-fixed">
                    <thead>
                        <tr>
                            <th style="width:120px">Time</th>
                            @foreach (var d in days)
                            {
                                <th>@d</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var slot in slots)
                        {
                            <tr>
                                <td>@slot.Start.ToString(@"hh\:mm") - @slot.End.ToString(@"hh\:mm")</td>

                                @foreach (var d in days)
                                {
                                    // ONLY enroled classes (backend already filters status = "Enroled")
                                    var items = Model.Enrolments?
                                    .Where(e => IsInSlot(e.Class.Schedule, d, slot.Start, slot.End))
                                    .ToList() ?? new List<OnlineEnrolmentSystem.Models.Enrolment>();

                                    <td class="tt-cell">
                                        @if (items.Count > 0)
                                        {
                                            <div class="tt-stack d-flex flex-column align-items-center">
                                                @foreach (var cls in items)
                                                {
                                                    var code = cls.Class.Course.CourseCode ?? "Course";
                                                    <div class="tt-pill" style="background-color:@ColorFor(code)">
                                                        @code <span class="fw-normal">Sec @cls.Class.Section</span>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (Model.Enrolments?.Count > 0)
            {
                var legend = Model.Enrolments
                .Select(e => e.Class.Course.CourseCode)
                .Where(c => !string.IsNullOrWhiteSpace(c))
                .Distinct()
                .OrderBy(c => c)
                .ToList();

                <div class="mt-3 small tt-legend">
                    <div class="fw-semibold mb-1">Legend</div>
                    @foreach (var c in legend)
                    {
                        <span class="tt-pill" style="background-color:@ColorFor(c)">@c</span>
                    }
                </div>
            }

            <div class="form-text mt-2">
                * Only enroled courses are shown. Colors are automatic per course code.
            </div>
        </div>
    </div>

</div>


    


